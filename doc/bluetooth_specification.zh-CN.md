# OpenBlink 蓝牙通信规范

## 概述

本文档描述了 OpenBlink 系统的蓝牙低功耗（BLE）通信规范。包括服务和特性 UUID、协议详情、数据结构和通信流程。

## 服务和特性

### OpenBlink 服务

- **服务 UUID**: `227da52c-e13a-412b-befb-ba2256bb7fbe`
- **描述**: OpenBlink 设备通信的主要服务

### 特性

| 特性   | UUID                                   | 属性             | 描述                 |
| ------ | -------------------------------------- | ---------------- | -------------------- |
| 程序   | `ad9fdd56-1135-4a84-923c-ce5a244385e7` | 写入，无响应写入 | 用于字节码传输和执行 |
| 控制台 | `a015b3de-185a-4252-aa04-7a87d38ce148` | 通知             | 用于调试输出和通知   |
| 状态   | `ca141151-3113-448b-b21a-6a6203d253ff` | 读取             | 提供设备状态信息     |

## 协议

### Blink 协议

- **版本**: 0x01
- **描述**: 用于在 OpenBlink 设备上传输和执行字节码的协议

### 命令类型

| 命令 | 代码 | 描述             |
| ---- | ---- | ---------------- |
| 数据 | 'D'  | 传输字节码块     |
| 程序 | 'P'  | 执行传输的字节码 |
| 重置 | 'R'  | 重置设备         |
| 重载 | 'L'  | 重载字节码       |

## 数据结构

### BLINK_CHUNK_HEADER

- **大小**: 2 字节
- **描述**: 所有 Blink 协议命令的通用头部

| 字段    | 类型    | 大小   | 描述                           |
| ------- | ------- | ------ | ------------------------------ |
| version | uint8_t | 1 字节 | Blink 协议版本（0x01）         |
| command | uint8_t | 1 字节 | 命令类型（'D'、'P'、'R'或'L'） |

### BLINK_CHUNK_DATA

- **大小**: 6 字节 + 数据
- **描述**: 数据块传输的结构

| 字段   | 类型               | 大小   | 描述                 |
| ------ | ------------------ | ------ | -------------------- |
| header | BLINK_CHUNK_HEADER | 2 字节 | 通用头部             |
| offset | uint16_t           | 2 字节 | 字节码缓冲区中的偏移 |
| size   | uint16_t           | 2 字节 | 数据块的大小         |
| data   | uint8_t[]          | 可变   | 实际字节码数据       |

### BLINK_CHUNK_PROGRAM

- **大小**: 8 字节
- **描述**: 程序执行命令的结构

| 字段     | 类型               | 大小   | 描述           |
| -------- | ------------------ | ------ | -------------- |
| header   | BLINK_CHUNK_HEADER | 2 字节 | 通用头部       |
| length   | uint16_t           | 2 字节 | 字节码总长度   |
| crc      | uint16_t           | 2 字节 | CRC16 校验和   |
| slot     | uint8_t            | 1 字节 | 字节码的目标槽 |
| reserved | uint8_t            | 1 字节 | 保留供将来使用 |

## 通信流程

### 字节码传输和执行

```
客户端                                      OpenBlink设备
  |                                               |
  |--- 发现OpenBlink服务 ------------------------>|
  |<-- 服务和特性发现 ----------------------------|
  |                                               |
  |--- 将数据块1写入程序特性 -------------------->|
  |--- 将数据块2写入程序特性 -------------------->|
  |--- 将数据块n写入程序特性 -------------------->|
  |                                               |
  |--- 将程序命令写入程序特性 ------------------->|
  |                   (CRC检查)                   |
  |                                               |
  |--- 写入重置/重载命令 ------------------------>|
  |                                               |
```

### BLE 事件

| 事件                   | 描述                |
| ---------------------- | ------------------- |
| BLE_EVENT_INITIALIZED  | BLE 堆栈已初始化    |
| BLE_EVENT_CONNECTED    | BLE 连接已建立      |
| BLE_EVENT_DISCONNECTED | BLE 连接已终止      |
| BLE_EVENT_RECEIVED     | 通过 BLE 接收数据   |
| BLE_EVENT_SENT         | 通过 BLE 发送数据   |
| BLE_EVENT_BLINK        | 接收到 Blink 字节码 |
| BLE_EVENT_STATUS       | 请求状态信息        |
| BLE_EVENT_REBOOT       | 接收到重启请求      |
| BLE_EVENT_RELOAD       | 接收到重载请求      |

## 实现注意事项

### 最大字节码大小

最大字节码大小在实现中由`BLINK_MAX_BYTECODE_SIZE`定义，设置为15KB（15 * 1024字节）。

### CRC 计算

CRC16 校验和使用`crc16_reflect`函数计算，参数如下：

- 初始值：0xFFFF
- 多项式：0xd175（为数据长度高达32751位提供汉明距离4保护）
- 输入：字节码缓冲区
- 长度：字节码长度

参考文献: https://users.ece.cmu.edu/~koopman/crc/index.html
