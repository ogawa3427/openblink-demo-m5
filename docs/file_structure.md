# ファイル構成

このドキュメントでは、ESP-IDFプロジェクトの一般的なファイル構成と、OpenBlinkプロジェクトにおける具体的な構成について説明します。

## ESP-IDFの標準的なファイル構成

ESP-IDF (Espressif IoT Development Framework) を使用するプロジェクトは、一般的に以下のような構造を持ちます。これは、ビルドシステム (CMake) がコンポーネントを検出し、プロジェクトを適切にビルドするために重要です。

-   `CMakeLists.txt` (プロジェクトルート): プロジェクト全体の設定、使用するESP-IDFのバージョン、およびプロジェクト固有のコンポーネントを定義します。
-   `sdkconfig`: `menuconfig` によって生成されるプロジェクトの構成設定ファイルです。ESP-IDFの機能、ライブラリ、ドライバなどの有効/無効やパラメータを設定します。
-   `main/`: プロジェクトのメインアプリケーションコードが含まれるディレクトリです。
    -   `CMakeLists.txt` (main内): `main` コンポーネントのソースファイルや依存関係を定義します。
    -   `main.c` または `app_main.c`: アプリケーションのエントリーポイントとなる `app_main` 関数が含まれます。
-   `components/`: プロジェクト固有の再利用可能なコードモジュール（コンポーネント）を配置するディレクトリです。各サブディレクトリが独立したコンポーネントとなり、それぞれに `CMakeLists.txt` が必要です。
-   `build/`: ビルドプロセス中に生成されるファイル（オブジェクトファイル、ライブラリ、最終的なファームウェアバイナリなど）が格納されます。通常、バージョン管理からは除外されます。
-   `managed_components/`: `idf.py add-dependency` コマンドなどで、ESP-IDF Component Registryからダウンロードされたコンポーネントが格納されます。

## OpenBlinkにおけるファイル構成

OpenBlinkはESP-IDFをベースとしていますが、mruby/cの統合やM5Stackデバイス向けの機能を提供するために、独自の構造も取り入れています。

-   `CMakeLists.txt` (プロジェクトルート): ESP-IDFプロジェクトとしての基本的な設定に加え、OpenBlinkに必要なコンポーネントやライブラリ（mruby/cなど）のビルド設定が含まれます。
-   `sdkconfig`: M5Stackのハードウェア機能（ディスプレイ、スピーカー、センサー等）や、mruby/cの有効化、ネットワーク設定など、OpenBlink固有の設定項目が多数含まれます。
-   `main/`:
    -   `main.c`: ESP-IDFの `app_main` 関数を定義するエントリーポイントです。ここでは、基本的な初期化処理の後、mruby/c仮想マシンを初期化し、Rubyスクリプト (`main.rb`) を実行します。
-   `src/`: OpenBlinkのコア機能やライブラリコードが格納されています。これはESP-IDFの `components` ディレクトリの考え方に近いですが、より細分化されています。
    -   `m5u/`: M5UnifiedライブラリのC++機能をmruby/cから呼び出すためのバインディングコードです。各ファイル (`c_m5display.cpp`, `c_m5button.cpp` など) が特定のハードウェア機能に対応します。
    -   `api/`: Rubyから利用可能な基本的なAPI（ファイル操作、タイマーなど）のC言語実装です。
    -   `rb/`: mruby/cで実行されるRubyスクリプトです。`main.rb` がアプリケーションの起点となります。
    -   `app/`: アプリケーションレベルの初期化や設定に関連するコードです。
    -   `drv/`: 低レベルなデバイスドライバやハードウェア抽象化層に関連するコードです。
-   `components/`: ESP-IDFの標準コンポーネントや、サードパーティ製のコンポーネント（例: `mruby_c`）が配置されます。
-   `mrblib/`: コンパイル済みのmrubyバイトコード (`.mrb` ファイル) を配置するためのディレクトリです（現在は `src/rb/` のスクリプトを直接VMで実行する方式が主かもしれません）。
-   `docs/`: プロジェクトのドキュメントが格納されます。

このように、OpenBlinkはESP-IDFの標準的な構造を踏襲しつつ、mruby/c環境とM5Stack向け機能を実現するために `src` ディレクトリ以下で独自のコード構成を採用しています。 